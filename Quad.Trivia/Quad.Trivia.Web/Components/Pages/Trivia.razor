@page "/trivia"
@using Quad.Trivia.ApiService.DTOs
@rendermode InteractiveServer

@inject TriviaApiClient TriviaApi
@inject IJSRuntime JS

<PageTitle>Trivia</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-body">
                    @if (question == null)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading question...</p>
                        </div>
                    }
                    else
                    {
                        <h5 class="card-title mb-4">
                            <span class="badge bg-info">@question.Category</span>
                            <span class="badge bg-warning">@question.Difficulty</span>
                        </h5>

                        <h2 class="mb-4">@question.Question</h2>

                        <div class="mb-4">
                            @foreach (var answer in question.PossibleAnswers)
                            {
                                var isWrong = WrongAnswers.Contains(answer);
                                var isDisabled = isWrong || IsAnswerCorrect || IsChecking;
                                var btnClass = isWrong ? "btn btn-outline-danger w-100 text-start" : "btn btn-outline-primary w-100 text-start";
                                if (IsAnswerCorrect && SelectedAnswer == answer)
                                {
                                    btnClass = "btn btn-success w-100 text-start";
                                }

                                <div class="mb-3">
                                    <button type="button" class="@btnClass" @onclick="async () => await OnAnswerClicked(answer)" disabled="@isDisabled">
                                        @if (isWrong)
                                        {
                                            <s>@answer</s>
                                        }
                                        else
                                        {
                                            @answer
                                        }
                                        @if (IsChecking && SelectedAnswer == answer)
                                        {
                                            <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
                                        }
                                    </button>
                                </div>
                            }
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button"
                                class="btn btn-secondary"
                                @onclick="ResetQuestion">
                                Next Question
                            </button>
                        </div>

                        @if (IsAnswerCorrect)
                        {
                            <div class="alert alert-success mt-4" role="alert">
                                <h4 class="alert-heading">🎉 Correct Answer! 🎉</h4>
                                <p>Congratulations! You got it right!</p>
                            </div>
                        }
                    }

                    @if (Score > 0)
                    {
                        <div class="mt-4 text-center">
                            <h5>Score: <span class="text-success">@Score</span> correct answer(s)</h5>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private QuestionDTO? question;
    private string? SelectedAnswer;
    private HashSet<string> WrongAnswers = new();
    private bool IsAnswerCorrect = false;
    private bool IsChecking = false;
    private int Score = 0;


    protected override async Task OnInitializedAsync()
    {
        await LoadNewQuestion();
    }

    private async Task LoadNewQuestion()
    {
        SelectedAnswer = null;
        WrongAnswers.Clear();
        IsAnswerCorrect = false;
        question = await TriviaApi.GetQuestionAsync();
    }
   
    private async Task OnAnswerClicked(string answer)
    {
        if (IsChecking || IsAnswerCorrect || WrongAnswers.Contains(answer) || question == null)
            return;

        SelectedAnswer = answer;
        IsChecking = true;
        try
        {
            var isCorrect = await TriviaApi.CheckAnswerAsync(question.QuestionId, answer);
            if (isCorrect)
            {
                IsAnswerCorrect = true;
                Score++;
            }
            else
            {
                WrongAnswers.Add(answer);
                SelectedAnswer = null;
            }
        }
        finally
        {
            IsChecking = false;
            StateHasChanged();
        }
    }

    private async Task ResetQuestion()
    {
        await LoadNewQuestion();
    }

    private string GetAnswerClass(string answer)
    {
        if (WrongAnswers.Contains(answer))
            return "is-invalid";
        if (SelectedAnswer == answer && !IsAnswerCorrect)
            return "is-valid";
        return "";
    }
}
